blueprint:
  name: Circadian Lighting for TP-Link Bulbs with Custom Times
  description: Adjusts brightness and color temperature of TP-Link bulbs based on sun position and specific times
  domain: automation
  input:
    light_group:
      name: Light Group
      description: The group of TP-Link lights to control
      selector:
        entity:
          domain: light
          multiple: true

variables:
  lights: !input light_group

trigger:
  - platform: time_pattern
    minutes: "/5"
  - platform: time
    at: "05:00:00"
  - platform: sun
    event: sunset
  - platform: time
    at: "22:00:00"

action:
  - variables:
      sun_elevation: "{{ state_attr('sun.sun', 'elevation') }}"
      current_time: "{{ now().strftime('%H:%M:%S') }}"
  - choose:
      # Early morning and evening (5 AM and sunset)
      - conditions:
          - condition: or
            conditions:
              - condition: time
                after: "05:00:00"
                before: "05:01:00"
              - condition: sun
                after: sunset
                before: sunset
                offset: "00:01:00"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_group
            data:
              brightness: 3  # 1% of 255
              kelvin: 1000
      # Daytime (after 5 AM and before sunset)
      - conditions:
          - condition: and
            conditions:
              - condition: time
                after: "05:01:00"
              - condition: sun
                before: sunset
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_group
            data:
              brightness: "{{ (((sun_elevation | float) / 90) * 255) | round(0) }}"
              kelvin: "{{ ((((sun_elevation | float) / 90) * 4500) + 2000) | round(0) }}"
      # Night time (after sunset and before 10 PM)
      - conditions:
          - condition: and
            conditions:
              - condition: sun
                after: sunset
              - condition: time
                before: "22:00:00"
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input light_group
            data:
              brightness: 3  # 1% of 255
              kelvin: 1000
      # Turn off at 10 PM
      - conditions:
          - condition: time
            after: "22:00:00"
            before: "05:00:00"
        sequence:
          - service: light.turn_off
            target:
              entity_id: !input light_group